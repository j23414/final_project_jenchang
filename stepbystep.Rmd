Work
========================================================
Load Required Libraries
```{r}
library(ggplot2)
library(GGally)
```

E coli microarray data under different stress treatments: gene_median.csv
```{r}
data<-read.table("data/gene_trans.csv", header=TRUE, stringsAsFactors=FALSE, sep=',')
dim(data)
head(data)
summary(data)
summary(subset(data,SD1==-1)) # 40 entries where the expressions are -1

data<-subset(data,SD1>=0) # dropped anything that had -1 accross all values
data<-subset(data,select=c(Name,C.2:PH1,SD1:UV2)) # Drop C1 and PH2, (bubble on the array)

n_names<-c("Name","Minimal C-source 2","Minimal C & N Source 1","Minimal C & N Source 2","Cold Shock rep 1","Cold Shock rep 2","Heat Shock rep 1","Heat Shock rep 2","Minimal N Source 1","Minimal N Source 2","Osmotic Shock 1","Osmotic Shock 2","Oxidative Stress 1","Oxidative Stress 2","Low pH 1","Control 1","Control 2","UV Treatment 1","UV Treatment 2")

names(data)<-n_names
head(data)
ggparcoord(data, columns=c(2:19))+geom_line()+labs(title="Expression Across All Treatments", x="Treatments", y="Expression")+theme(axis.text.x=element_text(angle=300,hjust=0))
```

Could normalize by a particular gene
```{r,eval=FALSE}
normalize_by_gene<-function(data,i){
  base<-data[i,]
  data.out<-data-base
  return(data.out)
}

d<-normalize_by_gene(data[,7:26],1)
```

WGCNA (Weighted Gene Co-Expression Network Analysis)
installation of WGCNA
```{r,eval=FALSE}
install.packages(c("dynamicTreeCut","cluster","flashClust","Hmisc","reshape","foreach","doParallel"))
source("http://bioconductor.org/biocLite.R")
biocLite("impute")
install.packages("WGCNA")

# GO Enrichment analysis
orgCodes = c("Hs", "Mm", "Rn", "Pf", "Sc", "Dm", "Bt", "Ce", "Cf", "Dr", "Gg"); 
orgExtensions = c(rep(".eg", 4), ".sgd", rep(".eg", 6)); 
packageNames = paste("org.", orgCodes, orgExtensions, ".db", sep=""); 

biocLite(c("GO.db", "KEGG.db", "topGO", packageNames, "hgu133a.db", "hgu95av2.db", "annotate", "hgu133plus2.db", "SNPlocs.Hsapiens.dbSNP.20100427", "minet", "OrderedList"))
```

Run Clustering
```{r,fig.width=9,fig.height=4}
library(WGCNA)
allowWGCNAThreads()

# Prepare data for input
input<-as.data.frame(t(data[,-1]))
names(input)=data$Name
head(input[,1:6])

# Choose soft threshold
powers=c(c(1:10),seq(from=12,to=30,by=2))
sft=pickSoftThreshold(input,powerVector=powers,verbose=5)

sizeGrWindow(9,5)
par(mfrow=c(1,2))
cex1=0.9
plot(sft$fitIndices[,1],-sign(sft$fitIndices[,3])*sft$fitIndices[,2], xlab="Soft Threshold (power)", ylab="Scale Free Topology Model Fit, signed R^2", main=paste("Scale independence"))
text(sft$fitIndices[,1],-sign(sft$fitIndices[,3])*sft$fitIndices[,2], labels=powers,cex=cex1,col="red")
abline(h=0.90,col="red")
plot(sft$fitIndices[,1],sft$fitIndices[,5],xlab="Soft Threshold (power)", ylab="Mean Connectivity", type="n", main=paste("Mean connectivity"))
text(sft$fitIndices[,1],sft$fitIndices[,5],labels=powers,cex=cex1,col="red")
```

Choose a soft threshold value near 0.9 or at least at the bend. I went with the bend because otherwise I only had 4 clusters.
```{r,fig.width=12,fig.height=9}
# Cluster into Modules
net=blockwiseModules(input,power=7,minModuleSize=30,reassignThreshold=0,mergeCutHeight=0.25,numericLabels=TRUE,pamRespectsDendro=FALSE,saveTOMs=TRUE,saveTOMFileBase="geneTOM",verbose=3)

# create dendrogram
sizeGrWindow(12,9)
mergedColors=labels2colors(net$colors)
plotDendroAndColors(net$dendrograms[[1]],mergedColors[net$blockGenes[[1]]],"Module colors",dendroLabels=FALSE,hang=0.03,addGuide=TRUE,guideHang=0.05)

unique(mergedColors)
table(net$colors)

# Creates the adjacency matrix for the genes
adjacency = adjacency(input, power = 7)
TOM = TOMsimilarity(adjacency) # takes some time
dimnames(TOM) = list(data$Name,data$Name)
```

Visualize the Clusters
```{r, fig.height=6, fig.width=8}
#sel.mod<-(mergedColors=="green")
data$cluster=mergedColors

# can't get facets to work with ggparcoord, must go back to ggplot
ggparcoord(data, columns=c(2:19),groupColumn=20)+geom_line()+labs(title="Clustered Genes", x="Treatments", y="Expression")+theme(axis.text.x=element_text(angle=300,hjust=0))
```
Facet by Cluster
```{r,fig.height=6,fig.width=8}
# facet by cluster
#library(dplyr)
#library(plyr)
library(reshape)
data.m<-melt.data.frame(data, id.vars=c("Name","cluster"))

ggplot(data.m, aes(x=variable,y=value,colour=cluster,group=Name))+geom_line()+facet_wrap(~cluster)+theme(axis.text.x=element_text(angle=300,hjust=0))+labs(title="Expression by Clustered Genes", x="Treatments", y="Expression")
```

Export clusters for different software
```{r, eval=FALSE}
# Export to cytoscape
module=c(unique(mergedColors))#"pink" # select module
genes=names(input)
inModule=(mergedColors==module)
modGenes=genes[inModule]
modTOM=TOM[inModule,inModule]
dimnames(TOM) = list(genes,genes)
dimnames(modTOM) = list(modGenes, modGenes)
# Export the network into edge and node list files Cytoscape can read
cyt = exportNetworkToCytoscape(TOM,
edgeFile = paste("CytoscapeInput-edges-", paste(module, collapse="-"), ".txt", sep=""),
nodeFile = paste("CytoscapeInput-nodes-", paste(module, collapse="-"), ".txt", sep=""),
weighted = TRUE,
threshold = 0.02,
nodeNames = genes,
#altNodeNames = modGenes,
nodeAttr = mergedColors);#[inModule]);
```

```{r, eval=FALSE}
library(iplots)
#JGR,rJava,JavaGD,iplots
install.packages("plumbr") # allows functions to change data.frames. otherwise data.frames are ridgid
library(cranvas)
library(maps)
library(plumbr)

data.kegg<-read.table("data/eco_gene_cluster_des.psv",header=TRUE,sep="|",stringsAsFactors=FALSE)
head(paste(substr(data.kegg$description,1,20),"...",sep=''))
data.path<-read.table("data/eco_path_des.psv",header=TRUE,sep="|",stringsAsFactors=FALSE)

```

Drawing network graphs with R/Bioconductor (graphviz)
```{r, eval=FALSE}
source("http://www.bioconductor.org/biocLite.R")
biocLite("Rgraphviz")
library("Rgraphviz")
set.seed(123)
V<-letters[1:10]
M<-1:4
g1<-randomGraph(V,M,0.2)
plot(g1)
plot(g1,"neato")
rEG <- new("graphNEL", nodes=c("A", "B","C"), edgemode="undirected")
rEG <- addEdge("A", "B", rEG, 5)
rEG <- addEdge("C","B", rEG, 3)

#rEG <- addEdge("A", "B", rEG, 1)

plot(rEG)
g1<-new("graphNEL",nodes=data$Name,edgemode="undirected")

# igraph
install.packages("igraph")
library(igraph)
net=graph.adjacency(adjmatrix=TOM,mode="undirected", weighted=TRUE, diag=FALSE)

```

Shiny Section
-------------
* maybe allow the user to select different clusters
* want to use the TOM distance matrix between each gene to generate a graph (as in nodes and edge graph)
* user can adjust the edge weights to cut off
* user can change node labels according to gene, keggid, description, cluster, etc

```{r, eval=FALSE}
install.packages("shiny")
library("shiny")
runExample("01_hello")
runExample("02_text")
runExample("03_reactivity")
runExample("04_mpg")
runExample("05_sliders")
runExample("06_tabsets")
runExample("07_widgets")
runExample("08_html")
runExample("09_upload")
runExample("10_download")
runExample("11_timer")

runApp("my_app")
```

Let the user select a module and produce a word cloud from gene ontology enrichment of the module.
```{r, eval=FALSE}
#install.packages("wordcloud")
library(wordcloud)
wordcloud(c(letters, LETTERS, 0:9), seq(1, 1000, len = 62)) # example

#install.packages("tm")
library(tm)
lords = Corpus(DirSource("data/temp")) # load Corpus
inspect(lords) 
lords <- tm_map(lords,stripWhitespace)
lords <- tm_map(lords,tolower)
lords <- tm_map(lords,removeWords,stopwords("english"))
lords <- tm_map(lords,stemDocument)
# removeNumbers, removePunctuation, removeWords,"nobel"
inspect(lords)

par(mar=rep(2,4))
wordcloud(lords,scale=c(5,0.5),max.words=100,random.order=FALSE,rot.per=0.35,use.r.layout=FALSE,colors=brewer.pal(8,"Dark2"))

# WGCNA GO Enrichment or I can use gene description or pathway description
annot <- read.csv(file="GeneAnnotation.csv")
probes=names(input)
probes2annot=match(probes,annot$substanceBXH)
allLLIDs = annot$LocusLinkID[probes2annot]
intModules=c("brown","red","pink")

```